<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Home</title>
    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="burgerMenu.css">
    <link rel="stylesheet" href="Umfrage.css">
    <link rel="stylesheet" href="bewertungtool.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <script src="Umfrage.js" defer></script>
</head>
<body>
    <div id="burger-menu-container">
        <div class="burger-menu" title="Wechseln Sie die Veranstaltung">
            <input type="checkbox" id="menu-toggle" />
            <label for="menu-toggle" class="menu-icon">
                <span></span>
                <span></span>
                <span></span>
            </label>
            <nav class="menu">
            <ul>
                <li class="has-submenu">
                <a href="#">Vorlesungen</a>
                <div class="submenu submenu-vorlesungen">
                <ul>
                    <li><a href="hci_prototype_V1.html">Vorlesung 1</a></li>
                    <li><a href="hci_prototype_V1.html">Vorlesung 2</a></li>
                    <li><a href="hci_prototype_V1.html">Vorlesung 3</a></li>
                </ul>
                </div>
                </li>
                <li class="has-submenu">
                    <a href="#">√úbungen</a>
                    <div class="submenu submenu-uebungen">
                        <ul>
                            <li><a href="hci_prototype_V1.html">√úbung 1</a></li>
                            <li><a href="hci_prototype_V1.html">√úbung 2</a></li>
                            <li><a href="hci_prototype_V1.html">√úbung 3</a></li>
                        </ul>
                    </div>
                </li>
            </ul>
            </nav>
        </div>
    </div>
    <div class="flexbox screen"> 
        <div class="section"> 
            <div class="block questions">
                <h2> Fragen der Studenten</h2>
                <p> Hier k√∂nnen Sie auf Fragen der Studenten eingehen. </p>
                <div>
                    <div id="questionsList"></div>
                </div>
            </div>
        </div>

        <div class="section">
            <div class="block-container">

                <div class="block"> 
                        <iframe src="bewertungtool.html" style="width:100%;height:100%;border:0;padding:5px;" title="Bewertungstool"></iframe>
                </div>
                <div class="split">

                </div>
                <div class="block"> 
                    <div class="survey-list">
                    </div>
                </div>
            </div>
        </div>

        <div class="section sidebar"> 
            <div class="flexbox verticalFlex">
            
                <div class="block qrCode" title="QR-Code f√ºr Studenten, √ºber den man der Session beitreten kann">
                    <div style="display:flex;flex-direction:column;align-items:center;justify-content:flex-start;height:auto;font-size:16px;color:#333;padding-top:10px;">
                        <div style="margin-bottom:8px; font-size: 14px;max-width: 95%;text-align: center;">Scan mich zum Beitreten</div>
                        <img src="../pictures/QR.png" alt="AR" id="arImage" style="max-width:95%;display:flex;margin:0 auto;padding-left: 5px;padding-right: 5px;" />
                    </div>
                </div>

                
                
                <div>
                    <div>
                        <div class="members" title="Anzahl der Teilnehmer">
                            <div class="participant">
                                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" aria-hidden="true">
                                    <path d="M12 12c2.761 0 5-2.239 5-5s-2.239-5-5-5-5 2.239-5 5 2.239 5 5 5z" fill="#444"/>
                                    <path d="M4 20c0-2.761 4-4 8-4s8 1.239 8 4v1H4v-1z" fill="#444"/>
                                </svg>
                                <span id="participantCount">1</span>
                            </div>
                        </div>
                    </div>
                    <div class="button button--fill">
                        <button id="openBewertungBtn">Bewertung erstellen</button>
                    </div>

                    <div class="button button--fill">
                        <button id="openSurveyBtn">Umfrage erstellen</button>
                    </div>

                    <div class="button button--fill">
                        <button id="openSessionBtn">Session starten</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="surveyContainer"> </div>

<script>
window.USER_TYPE = 'prof';
const VOTE_KEY = 'hci_votes_v1_' + window.USER_TYPE;

(function () {
    const STORAGE_KEY = 'hci_questions_v1';
    const questionsListEl = document.getElementById('questionsList');
    const inputEl = document.getElementById('questionInput');
    const submitBtn = document.getElementById('submitQuestion');

    function loadQuestions() {
        try {
            const raw = localStorage.getItem(STORAGE_KEY);
            return raw ? JSON.parse(raw) : [];
        } catch {
            return [];
        }
    }

    function saveQuestions(list) {
        localStorage.setItem(STORAGE_KEY, JSON.stringify(list));
    }

    function loadVotes() {
        try { return JSON.parse(localStorage.getItem(VOTE_KEY)) || {}; } 
        catch { return {}; }
    }

    function saveVotes(votes) {
        localStorage.setItem(VOTE_KEY, JSON.stringify(votes));
    }

    function seedIfEmpty() {
        const q = loadQuestions();
        if (!q || q.length === 0) {
            const sample = [{
                id: Date.now().toString(36) + Math.random().toString(36).slice(2,8),
                text: 'Was sind Metaphern?',
                votes: 3,
                created: Date.now()
            }];
            saveQuestions(sample);
        }
    }

    function createCardElement(q) {
        const card = document.createElement('div');
        card.className = 'question-card';
        card.dataset.id = q.id;

        const meta = document.createElement('p');
        meta.className = 'question-meta';
        meta.textContent = 'Ein Student fragt:';
        card.appendChild(meta);

        const txt = document.createElement('p');
        txt.className = 'question-text';
        txt.textContent = q.text;
        card.appendChild(txt);

        const actions = document.createElement('div');
        actions.className = 'question-actions';

        const upBtn = document.createElement('button');
        upBtn.className = 'upvote';
        upBtn.title = 'Frage upvoten';
        upBtn.dataset.id = q.id;
        upBtn.innerHTML = '‚¨Ü <span>' + (q.votes || 0) + '</span>';

        const downBtn = document.createElement('button');
        downBtn.className = 'downvote';
        downBtn.title = 'Frage downvoten';
        downBtn.dataset.id = q.id;
        downBtn.textContent = '‚¨á';

        const deleteBtn = document.createElement('button');
        deleteBtn.className = 'delete';
        deleteBtn.title = 'Frage l√∂schen';
        deleteBtn.dataset.id = q.id;
        deleteBtn.textContent = 'üóë';

        actions.appendChild(upBtn);
        actions.appendChild(downBtn);
        actions.appendChild(deleteBtn);
        card.appendChild(actions);

        const votesState = loadVotes();
        const currentVote = votesState[q.id];

        upBtn.classList.remove('active');
        downBtn.classList.remove('active');
        if (currentVote === 'up') upBtn.classList.add('active');
        if (currentVote === 'down') downBtn.classList.add('active');

        return card;
    }

    function renderQuestions() {
        const questions = loadQuestions();
        if (!questionsListEl) return;
        questionsListEl.innerHTML = '';
        questions.sort((a,b) => (b.votes||0) - (a.votes||0) || (a.created||0) - (b.created||0));
        questions.forEach(q => questionsListEl.appendChild(createCardElement(q)));
    }

    function addQuestion(text) {
        if (!text || !text.trim()) return;
        const questions = loadQuestions();
        const item = { 
            id: Date.now().toString(36) + Math.random().toString(36).slice(2,8), 
            text: text.trim(), 
            votes: 0, 
            created: Date.now() 
        };
        questions.push(item);
        saveQuestions(questions);
        renderQuestions();
    }

    function updateVotes(id, delta) {
        const votesState = loadVotes();
        const questions = loadQuestions();
        const idx = questions.findIndex(q => q.id === id);
        if (idx === -1) return;

        const currentVote = votesState[id];

        // Upvote
        /*if (delta > 0) {
            if (currentVote === 'up') { // zur√ºcknehmen
                questions[idx].votes -= 1;
                votesState[id] = undefined;
            } else if (currentVote === 'down') { // wechseln
                questions[idx].votes += 2;
                votesState[id] = 'up';
            } else { // normal
                questions[idx].votes += 1;
                votesState[id] = 'up';
            }
        }
        // Downvote
        else if (delta < 0) {
            if (currentVote === 'down') { // zur√ºcknehmen
                questions[idx].votes += 1;
                votesState[id] = undefined;
            } else if (currentVote === 'up') { // wechseln
                questions[idx].votes -= 2;
                votesState[id] = 'down';
            } else { // normal
                questions[idx].votes -= 1;
                votesState[id] = 'down';
            }
        }*/

        saveVotes(votesState);
        saveQuestions(questions);
        renderQuestions();
    }

    function deleteQuestion(id) {
        let questions = loadQuestions();
        const idx = questions.findIndex(q => q.id === id);
        if (idx === -1) return;
        questions.splice(idx, 1);
        saveQuestions(questions);
        renderQuestions();
    }

    // --- Event Listener ---
    if (questionsListEl) {
        questionsListEl.addEventListener('click', function(e) {
            const up = e.target.closest('.upvote');
            const down = e.target.closest('.downvote');
            const del = e.target.closest('.delete');
            if (up) updateVotes(up.dataset.id, +1);
            else if (down) updateVotes(down.dataset.id, -1);
            else if (del) {
                if (confirm('Diese Frage wirklich l√∂schen?')){
                    deleteQuestion(del.dataset.id);
                }
            }
        });
    }

    if (submitBtn) {
        submitBtn.addEventListener('click', function(e) {
            e.preventDefault();
            addQuestion(inputEl.value);
            inputEl.value = '';
        });
    }

    if (inputEl) {
        inputEl.addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                e.preventDefault();
                submitBtn.click();
            }
        });
    }

    window.addEventListener('storage', function(e) {
        if (e.key === STORAGE_KEY) renderQuestions();
    });

    // Initial
    seedIfEmpty();
    renderQuestions();
    
})();

const bewertungBtn = document.getElementById('openBewertungBtn');

if (bewertungBtn) {
    bewertungBtn.addEventListener('click', function (e) {
        e.preventDefault();

        const w = 720;
        const h = 560;

        // Position & Gr√∂√üe des aktuellen Browserfensters
        const dualScreenLeft = window.screenLeft !== undefined ? window.screenLeft : window.screenX;
        const dualScreenTop  = window.screenTop  !== undefined ? window.screenTop  : window.screenY;

        const width  = window.innerWidth  || document.documentElement.clientWidth;
        const height = window.innerHeight || document.documentElement.clientHeight;

        // Zentrierung relativ zum Browserfenster
        const left = dualScreenLeft + (width - w) / 2;
        const top  = dualScreenTop  + (height - h) / 2;

        const popup = window.open(
            'bewertung_popup.html',
            'bewertungPopup',
            `width=${w},height=${h},left=${left},top=${top},resizable=yes,scrollbars=yes`
        );

        // Fallback falls Popup blockiert wird
        if (!popup) {
            window.location.href = 'bewertung_popup.html';
        }
    });
}

document.addEventListener('DOMContentLoaded', function () {

    const sessionBtn = document.getElementById('openSessionBtn');
    const participantCountEl = document.getElementById('participantCount');

    function setSessionStartedUI() {
        if (!sessionBtn) return;
        sessionBtn.textContent = 'Session gestartet';
        sessionBtn.title = 'Die Session ist gestartet, User k√∂nnen bereits beitreten.'
        sessionBtn.disabled = true;
    }

    // ‚úÖ Beim Laden pr√ºfen, ob Session schon l√§uft
    if (localStorage.getItem('sessionStarted') === 'true') {
        setSessionStartedUI();
    }

    // ‚ñ∂ Session starten
    if (sessionBtn) {
        sessionBtn.addEventListener('click', function (e) {
            e.preventDefault();

            const n = prompt('Teilnehmerzahl eingeben', '1');
            if (n === null) return;

            let num = parseInt(n, 10);
            if (isNaN(num) || num < 0) num = 0;

            if (participantCountEl) {
                participantCountEl.textContent = String(num);
            }

            // Session speichern
            localStorage.setItem('sessionStarted', 'true');

            // UI √§ndern
            setSessionStartedUI();

            // Andere Tabs / Ger√§te informieren
            try {
                if (window.BroadcastChannel) {
                    const ch = new BroadcastChannel('hci_channel');
                    ch.postMessage({ type: 'sessionStarted', value: true });
                    ch.close();
                }
            } catch (err) {
                console.warn(err);
            }
        });
    }
});

</script> 
  
</body>
</html>