<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Home</title>
    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="burgerMenu.css">
    <link rel="stylesheet" href="Umfrage.css">
    <link rel="stylesheet" href="bewertungtool.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <script src="Umfrage.js" defer></script>
    <script src="bewertungentool.js" defer></script>
</head>
<body>
    <div id="burger-menu-container">
        <div class="burger-menu" title="Wechseln Sie die Veranstaltung">
            <input type="checkbox" id="menu-toggle" />
            <label for="menu-toggle" class="menu-icon">
                <span></span>
                <span></span>
                <span></span>
            </label>
            <nav class="menu">
            <ul>
                <li class="has-submenu">
                <a href="#">Vorlesungen</a>
                <div class="submenu submenu-vorlesungen">
                <ul>
                    <li><a href="hci_prototype_V1.html">Vorlesung 1</a></li>
                    <li><a href="hci_prototype_V1.html">Vorlesung 2</a></li>
                    <li><a href="hci_prototype_V1.html">Vorlesung 3</a></li>
                </ul>
                </div>
                </li>
                <li class="has-submenu">
                    <a href="#">√úbungen</a>
                    <div class="submenu submenu-uebungen">
                        <ul>
                            <li><a href="hci_prototype_V1.html">√úbung 1</a></li>
                            <li><a href="hci_prototype_V1.html">√úbung 2</a></li>
                            <li><a href="hci_prototype_V1.html">√úbung 3</a></li>
                        </ul>
                    </div>
                </li>
            </ul>
            </nav>
        </div>
    </div>
    <div class="flexbox screen"> 
        <div class="section"> 
            <div class="block questions">
                <h2> Fragen der Studenten</h2>
                <p> Hier k√∂nnen Sie auf Fragen der Studenten eingehen. </p>

                <div>
                    Filtern nach:
                    <select class="dropdown-filter" id="dropdown-filter">
                        <option value="Zu beantworten">Zu beantworten</option>
                        <option value="Schon beantwortet">Schon beantwortet</option>
                        <option value="Alle Fragen ohne Reden, alles komplett">Alle Fragen ohne Reden, alles komplett</option>
                    </select>
                </div>

                <div>
                    <div id="questionsList"></div>
                </div>
            </div>
        </div>

        <div class="section">
            <div class="block-container">

                <div class="block"> 
                        <div>
                            <h2 class="feedback-title">Bewertungen</h2>
                        </div>
                        <iframe src="bewertungtool.html" style="width:100%;height:100%;border:0;padding:5px;" title="Bewertungstool"></iframe>
                </div>
                <div class="split">

                </div>
                <div class="block"> 
                    <div class="survey-list"></div>
                    <div>
                        <h2 class="survey-title">Umfragen</h2>
                    </div>
                </div>
            </div>
        </div>

        <div class="section sidebar"> 
            <div class="flexbox verticalFlex">
            
                <div class="block qrCode" title="QR-Code f√ºr Studenten, √ºber den man der Session beitreten kann">
                    <div style="display:flex;flex-direction:column;align-items:center;justify-content:flex-start;height:auto;font-size:16px;color:#333;padding-top:10px;">
                        <div style="margin-bottom:8px; font-size: 14px;max-width: 95%;text-align: center;">Scan mich zum Beitreten</div>
                        <img src="../pictures/QR.png" alt="AR" id="arImage" style="max-width:95%;display:flex;margin:0 auto;padding-left: 5px;padding-right: 5px;" />
                    </div>
                </div>

                
                
                <div>
                    <div>
                        <div class="members" title="Anzahl der Teilnehmer">
                            <div class="participant">
                                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" aria-hidden="true">
                                    <path d="M12 12c2.761 0 5-2.239 5-5s-2.239-5-5-5-5 2.239-5 5 2.239 5 5 5z" fill="#444"/>
                                    <path d="M4 20c0-2.761 4-4 8-4s8 1.239 8 4v1H4v-1z" fill="#444"/>
                                </svg>
                                <span id="participantCount">1</span>
                            </div>
                        </div>
                    </div>
                    <div class="button button--fill">
                        <button id="openBewertungBtn">Bewertung erstellen</button>
                    </div>

                    <div class="button button--fill">
                        <button id="openSurveyBtn">Umfrage erstellen</button>
                    </div>

                    <div class="button button--fill">
                        <button id="openSessionBtn">Session starten</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="surveyContainer"> </div>

<script>
window.USER_TYPE = 'prof';
const VOTE_KEY = 'hci_votes_v1_' + window.USER_TYPE;

(function () {
    const STORAGE_KEY = 'hci_questions_v1';
    const questionsListEl = document.getElementById('questionsList');
    const inputEl = document.getElementById('questionInput');
    const submitBtn = document.getElementById('submitQuestion');
    const filterSelect = document.getElementById('dropdown-filter');

    function loadQuestions() {
        try {
            const raw = localStorage.getItem(STORAGE_KEY);
            const questions = raw ? JSON.parse(raw) : [];

            return questions.map(q => ({
                ...q,
                isAnswered: q.isAnswered ?? false
            }))

        } catch {
            return [];
        }
    }

    function saveQuestions(list) {
        localStorage.setItem(STORAGE_KEY, JSON.stringify(list));
    }

    function loadVotes() {
        try { return JSON.parse(localStorage.getItem(VOTE_KEY)) || {}; } 
        catch { return {}; }
    }

    function saveVotes(votes) {
        localStorage.setItem(VOTE_KEY, JSON.stringify(votes));
    }


    function createCardElement(q) {
        const card = document.createElement('div');
        card.className = 'question-card';
        card.dataset.id = q.id;

        if(q.isAnswered){
            card.classList.add('answered');
        }

        const meta = document.createElement('p');
        meta.className = 'question-meta';
        meta.textContent = 'Ein Student fragt:';
        card.appendChild(meta);

        const txt = document.createElement('p');
        txt.className = 'question-text';
        txt.textContent = q.text;
        card.appendChild(txt);

        const actions = document.createElement('div');
        actions.className = 'question-actions';

        const upBtn = document.createElement('button');
        upBtn.className = 'upvote';
        upBtn.title = 'Frage upvoten';
        upBtn.dataset.id = q.id;
        upBtn.innerHTML = '‚¨Ü <span>' + (q.votes || 0) + '</span>';

        const answerBtn = document.createElement('button');
        answerBtn.className = 'answer';
        answerBtn.title = 'Als beantwortet markieren';
        answerBtn.dataset.id = q.id;

        answerBtn.textContent = q.isAnswered
            ? 'Antwort zur√ºcknehmen'
            : 'Als beantwortet markieren';

        
        const deleteBtn = document.createElement('button');
        deleteBtn.className = 'delete';
        deleteBtn.title = 'Frage l√∂schen';
        deleteBtn.dataset.id = q.id;
        deleteBtn.textContent = 'üóë';

        actions.appendChild(upBtn);

        actions.appendChild(answerBtn);

        actions.appendChild(deleteBtn);
        card.appendChild(actions);

        const votesState = loadVotes();
        const currentVote = votesState[q.id];

        upBtn.classList.remove('active');;
        if (currentVote === 'up') upBtn.classList.add('active');

        return card;
    }

    function renderQuestions() {
        let questions = loadQuestions();
        if (!questionsListEl) return;

        const filter = filterSelect?.value;

        if (filter === 'Zu beantworten') {
            questions = questions.filter(q => !q.isAnswered);
        } else if (filter === 'Schon beantwortet') {
            questions = questions.filter(q => q.isAnswered);
        } else if (filter === 'Alle Fragen ohne Reden, alles komplett') {
        questions = questions;
        }

        questionsListEl.innerHTML = '';
        questions.sort((a,b) => (b.votes||0) - (a.votes||0) || (a.created||0) - (b.created||0));
        questions.forEach(q => questionsListEl.appendChild(createCardElement(q)));
    }

    function addQuestion(text) {
        if (!text || !text.trim()) return;
        const questions = loadQuestions();
        const item = { 
            id: Date.now().toString(36) + Math.random().toString(36).slice(2,8), 
            text: text.trim(), 
            votes: 0, 
            created: Date.now() 
        };
        questions.push(item);
        saveQuestions(questions);
        renderQuestions();
    }

    function updateVotes(id, delta) {
        const votesState = loadVotes();
        const questions = loadQuestions();
        const idx = questions.findIndex(q => q.id === id);
        if (idx === -1) return;

        const currentVote = votesState[id];


        saveVotes(votesState);
        saveQuestions(questions);
        renderQuestions();
    }

    function deleteQuestion(id) {
        let questions = loadQuestions();
        const idx = questions.findIndex(q => q.id === id);
        if (idx === -1) return;
        questions.splice(idx, 1);
        saveQuestions(questions);
        renderQuestions();
    }

    function toggleAnswered(id) {
        const questions = loadQuestions();
        const idx = questions.findIndex(q => q.id === id);
        if (idx === -1) return;

        questions[idx].isAnswered = !questions[idx].isAnswered;

        saveQuestions(questions);
        renderQuestions();
    }

    // --- Event Listener ---
    if (questionsListEl) {
        questionsListEl.addEventListener('click', function(e) {
            const up = e.target.closest('.upvote');
            const del = e.target.closest('.delete');
            const answer = e.target.closest('.answer');

            if (up) updateVotes(up.dataset.id, +1);
            else if (answer) {
                toggleAnswered(answer.dataset.id);
            }
            else if (del) {
                if (confirm('Diese Frage wirklich l√∂schen?')){
                    deleteQuestion(del.dataset.id);
                }
            }
        });
    }

    if (submitBtn) {
        submitBtn.addEventListener('click', function(e) {
            e.preventDefault();
            addQuestion(inputEl.value);
            inputEl.value = '';
        });
    }

    if (inputEl) {
        inputEl.addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                e.preventDefault();
                submitBtn.click();
            }
        });
    }

     if (filterSelect) {
        filterSelect.addEventListener('change', function () {
            renderQuestions();
        });
    }

    window.addEventListener('storage', function(e) {
        if (e.key === STORAGE_KEY) renderQuestions();
    });

    // Initial
    renderQuestions();
    
})();

const bewertungBtn = document.getElementById('openBewertungBtn');


if (bewertungBtn) {
    bewertungBtn.addEventListener('click', function (e) {
        e.preventDefault();

        // Falls Popup schon existiert ‚Üí nicht erneut erzeugen
        if (document.getElementById('bewertungPopup')) return;

        // Overlay
        const overlay = document.createElement('div');
        overlay.className = 'popup-rating';
        overlay.id = 'bewertungPopup';

        // Popup-Inhalt
        overlay.innerHTML = `
            <div class="popup-content">
                <button class="close-btn" id="closePopupBtn">&times;</button>
                <h2>Bewertung erstellen</h2>

                <p class = "was">Gib eine Frage f√ºr die Bewertung ein:</p>
                <textarea id="ratingText" rows="7"></textarea>

                <div class="controls">

                    <div class="dropdown">
                        <button id="showSuggestionsBtn" class="btn" aria-expanded="true" aria-controls="suggestions">
                            <span class="btn-label">Vorschl√§ge</span>
                            <span class="chevron" aria-hidden="true">‚ñæ</span>
                        </button>

                    <div id="suggestions" class="dropdown-menu" role="menu" aria-hidden="true" style="display: none;">
                    <div id="suggestionsList" class="suggestions-list"></div>
                    <div class="dropdown-footer">
                        <button id="manageBtn" class="btn small">Vorschl√§ge bearbeiten</button>
                    </div>
                    <div id="managePanel" class="manage-panel" aria-hidden="true">
                        <input id="newSuggestionInput" type="text" placeholder="Neue Vorschlag hinzuf√ºgen..." />
                        <button id="addSuggestionBtn" class="btn small">Hinzuf√ºgen</button>
                        <ul id="manageList" class="manage-list"></ul>
                    </div>
                </div>
            </div>
                    

                    
                    <button class="btn primary" id="saveBtn">Speichern</button>
                </div>
          
            </div>
        `;


        const saveBtn = overlay.querySelector('#saveBtn');  // Dein Speichern-Button
        const textarea = overlay.querySelector('#ratingText'); // Textarea
        let polls = [];
        const pollsKey = 'rating_polls';


        function loadPolls() {
            try {
                const raw = localStorage.getItem(pollsKey);
                polls = raw ? JSON.parse(raw) : [];
            } catch (e) {
                polls = [];
            }
        }


        function savePolls() {
            try {
                localStorage.setItem(pollsKey, JSON.stringify(polls));
            } catch (e) {
                console.warn('Polls konnten nicht gespeichert werden', e);
            }
        }


        function renderPolls() {
            const container = document.getElementById('polls'); 
            if (!container) return;
            container.innerHTML = '';
            if (!polls.length) {
                container.textContent = 'Keine Fragen zum Bewerten vorhanden.';
                return;
            }
            polls.forEach(poll => {
                const div = document.createElement('div');
                div.className = 'poll';
                div.textContent = poll.text;
                container.appendChild(div);
            });
        }

        function saveRating() {
            const value = textarea.value.trim();
            if (!value) {
                alert('Bitte gib einen Text ein oder w√§hle einen Vorschlag.');
                textarea.focus();
                return;
            }

            const id = 'poll_' + Date.now();
            const poll = { id: id, text: value, yes: 0, no: 0, neutral: 0, createdAt: Date.now() };

            polls.unshift(poll);
            savePolls();
            renderPolls();

            overlay.remove();
        }

        if (saveBtn) {
            saveBtn.addEventListener('click', function(e) {
                e.preventDefault();
                saveRating();
            });
        }


        loadPolls();
        renderPolls();

        

        // Suggestions laden und initialisieren
        let suggestions = [];
        const storageKey = 'rating_suggestions';
        const suggestionsListEl = overlay.querySelector('#suggestionsList');
        
        // Vorschl√§ge aus localStorage oder suggestions.json laden
        (function loadSuggestions() {
            const stored = localStorage.getItem(storageKey);
            if (stored) {
                try {
                    const parsed = JSON.parse(stored);
                    if (Array.isArray(parsed) && parsed.length) {
                        suggestions = parsed;
                        renderSuggestions();
                        return;
                    }
                } catch (e) {
                    console.warn('Lokale Vorschl√§ge konnten nicht gelesen werden.', e);
                }
            }

            fetch('suggestions.json')
                .then(function (res) {
                    if (!res.ok) throw new Error('Network response was not ok');
                    return res.json();
                })
                .then(function (data) {
                    if (Array.isArray(data) && data.length) {
                        suggestions = data;
                        renderSuggestions();
                    }
                })
                .catch(function (err) {
                    console.warn('Konnte suggestions.json nicht laden, verwende Standard-Vorschl√§ge.', err);
                    suggestions = ['Frage 1 zu verst√§ndlich?', 'Tempo der Vorlesung okay?', 'Verst√§ndnis von Konzept X?'];
                    renderSuggestions();
                });
        })();

        function renderSuggestions() {
            if (!suggestionsListEl) return;
            suggestionsListEl.innerHTML = '';

            suggestions.forEach(function (s) {
                const item = document.createElement('div');
                item.className = 'suggestion-item';
                item.setAttribute('role', 'menuitem');
                item.tabIndex = 0;
                item.textContent = s;
                item.addEventListener('click', function () {
                    const textarea = overlay.querySelector('#ratingText');
                    if (textarea) textarea.value = s;
                    hideSuggestions();
                });
                suggestionsListEl.appendChild(item);
            });
        }

        document.body.appendChild(overlay);


        // Klick auf Hintergrund schlie√üt Popup
        overlay.addEventListener('click', (ev) => {
            if (ev.target === overlay) {
                overlay.remove();
            }
        });

        function hideSuggestions() {
            const suggestionsEl = document.getElementById('suggestions');
            if (!suggestionsEl) return; // nichts tun, falls Element nicht existiert

            const showSuggestionsBtn = document.getElementById('showSuggestionsBtn');

            suggestionsEl.style.display = 'none';
            suggestionsEl.setAttribute('aria-hidden', 'true');

            if (showSuggestionsBtn) {
                showSuggestionsBtn.setAttribute('aria-expanded', 'false');
                const chevron = showSuggestionsBtn.querySelector('.chevron');
                if (chevron) chevron.textContent = '‚ñæ';
            }
        }

        function showSuggestions() {
            const suggestionsEl = document.getElementById('suggestions');
            if (!suggestionsEl) return; // nichts tun, falls Element nicht existiert

            const showSuggestionsBtn = document.getElementById('showSuggestionsBtn');

            suggestionsEl.style.display = 'block';
            suggestionsEl.setAttribute('aria-hidden', 'false');

            if (showSuggestionsBtn) {
                showSuggestionsBtn.setAttribute('aria-expanded', 'false');
                const chevron = showSuggestionsBtn.querySelector('.chevron');
                if (chevron) chevron.textContent = '‚ñ¥'; 
            }
        }

        const primaryBtn = document.querySelector('.btn');

        primaryBtn.addEventListener('click', function(e) {
            const suggestionsEl = document.getElementById('suggestions');
            if (suggestionsEl.style.display === 'block') hideSuggestions(); else showSuggestions();
        });

        const exitBtn = document.getElementById("closePopupBtn");

        exitBtn.addEventListener('click', function(e) {
            overlay.remove();
        });  

    });
}




document.addEventListener('DOMContentLoaded', function () {



    const sessionBtn = document.getElementById('openSessionBtn');
    const participantCountEl = document.getElementById('participantCount');

    function setSessionStartedUI() {
        if (!sessionBtn) return;
        sessionBtn.textContent = 'Session gestartet';
        sessionBtn.title = 'Die Session ist gestartet, User k√∂nnen bereits beitreten.'
        sessionBtn.disabled = true;
    }

    // ‚úÖ Beim Laden pr√ºfen, ob Session schon l√§uft
    if (localStorage.getItem('sessionStarted') === 'true') {
        setSessionStartedUI();
    }

    // ‚ñ∂ Session starten
    
    if (sessionBtn) {
        sessionBtn.addEventListener('click', function (e) {
            e.preventDefault();

            const n = prompt('Teilnehmerzahl eingeben', '1');
            if (n === null) return;

            let num = parseInt(n, 10);
            if (isNaN(num) || num < 0) num = 0;

            if (participantCountEl) {
                participantCountEl.textContent = String(num);
            }

            // Session speichern
            localStorage.setItem('sessionStarted', 'true');

            // UI √§ndern
            setSessionStartedUI();

            // Andere Tabs / Ger√§te informieren
            try {
                if (window.BroadcastChannel) {
                    const ch = new BroadcastChannel('hci_channel');
                    ch.postMessage({ type: 'sessionStarted', value: true });
                    ch.close();
                }
            } catch (err) {
                console.warn(err);
            }
        });
    }

});

</script> 

<script src="bewertungentool.js"></script>
  
</body>
</html>