<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HandyHome</title>
    <link rel="stylesheet" href="HandyHome.css">
    <link rel="stylesheet" href="Handyleiste.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;500;600;700&display=swap" rel="stylesheet">
</head>
<body>
    <div class="screen">
        <div class="section">
            <iframe src="bewertungtool_mobile.html" style="width:100%;height:45vh;border:0;" title="Bewertungstool"></iframe>
        </div>
    </div>

    <div class="screen">
        <div class="section">
            <div class="wrap" id="surveysWrap">
            </div>
        </div>
    </div>


    <div class="bottom-nav">
        <button id="fragen" onclick="window.location.href='HandyQuestions.html'">Fragen</button>
        <button id="home" class="active">Home</button>
        <button id="raeume" onclick="window.location.href='HandyRäume.html'">Räume</button>
    </div>

    <script>
document.addEventListener('DOMContentLoaded', function () {

    const container = document.getElementById('surveysWrap');

    /* ========= Load surveys from savedSurveys ========= */
    function loadSurveys() {
        try {
            const raw = localStorage.getItem('savedSurveys');
            const surveys = raw ? JSON.parse(raw) : [];
            return Array.isArray(surveys) ? surveys : [];
        } catch (e) {
            console.warn('Error loading savedSurveys', e);
            return [];
        }
    }

    /* ========= Votes (per device) ========= */
    function loadVotes() {
        try {
            return JSON.parse(localStorage.getItem('rating_votes') || '{}');
        } catch {
            return {};
        }
    }

    function saveVotes(votes) {
        localStorage.setItem('rating_votes', JSON.stringify(votes));
    }

    function hasVoted(id) {
        return loadVotes()[id] !== undefined;
    }

    function recordVote(id, answerIndex) {
        const votes = loadVotes();
        votes[id] = answerIndex;
        saveVotes(votes);
    }

    /* ========= Render ========= */
    function render() {
        container.innerHTML = '';

        const surveys = loadSurveys();

        if (!surveys.length) {
            container.innerHTML = '<p>Keine Umfragen vorhanden.</p>';
            return;
        }

        surveys.forEach(survey => {
            if (!survey.id || !Array.isArray(survey.answers)) return;

            const box = document.createElement('div');
            box.className = 'survey';

            const question = document.createElement('div');
            question.className = 'poll-question';
            question.textContent = survey.question || 'Frage';
            box.appendChild(question);

            const options = document.createElement('div');
            options.className = 'poll-options';

            const votedIndex = loadVotes()[survey.id];

            survey.answers.forEach((answer, index) => {
                const btn = document.createElement('button');
                btn.className = 'poll-option';
                btn.textContent = answer;

                if (votedIndex !== undefined) {
                    btn.disabled = true;
                    if (votedIndex === index) {
                        btn.classList.add('voted');
                    }
                } else {
                    btn.addEventListener('click', () => {
                        recordVote(survey.id, index);
                        render();
                    });
                }

                options.appendChild(btn);
            });

            box.appendChild(options);
            container.appendChild(box);
        });
    }

    render();

    let lastSavedSurveys = localStorage.getItem('savedSurveys') || '';

    window.addEventListener('storage', (e) => {
        if (e.key === 'savedSurveys') {
            render();
            lastSavedSurveys = localStorage.getItem('savedSurveys') || '';
        }
    });


    setInterval(() => {
        const current = localStorage.getItem('savedSurveys') || '';
        if (current !== lastSavedSurveys) {
            lastSavedSurveys = current;
            render();
        }
    }, 2000);
});
</script>

</body>
</html>