<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HandyHome</title>
    <link rel="stylesheet" href="HandyHome.css">
    <link rel="stylesheet" href="Handyleiste.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;500;600;700&display=swap" rel="stylesheet">
</head>
<body>
    <div class="screen">
        <div class="section">
            <iframe src="bewertungtool_mobile.html" style="width:100%;height:45vh;border:0;" title="Bewertungstool"></iframe>
        </div>
    </div>

    <div class="screen">
        <div class="section">
            <div class="wrap" id="surveysWrap">
            </div>
        </div>
    </div>


    <div class="bottom-nav">
        <button id="fragen" onclick="window.location.href='HandyQuestions.html'">Fragen</button>
        <button id="home" class="active">Home</button>
        <button id="raeume" onclick="window.location.href='HandyR√§ume.html'">R√§ume</button>
    </div>

    <script>
    document.addEventListener('DOMContentLoaded', function () {
        const POLLS_KEY = 'rating_polls';
        const container = document.getElementById('surveysWrap');

        function loadPolls() {
            try {
                const raw = localStorage.getItem(POLLS_KEY);
                return raw ? JSON.parse(raw) : [];
            } catch (e) { console.warn('Could not read polls', e); return []; }
        }

        function loadVotes() {
            try { return JSON.parse(localStorage.getItem('rating_votes')||'{}'); } catch (e) { return {}; }
        }

        function saveVotes(votes) {
            try { localStorage.setItem('rating_votes', JSON.stringify(votes)); } catch (e) {}
        }

        function hasVoted(pollId) {
            var v = loadVotes();
            return v && v[pollId] !== undefined;
        }

        function recordVoteLocal(pollId, choice) {
            var v = loadVotes();
            v[pollId] = choice;
            saveVotes(v);
        }

        function savePolls(polls) {
            try {
                localStorage.setItem(POLLS_KEY, JSON.stringify(polls));
                try { if (window.BroadcastChannel) new BroadcastChannel('rating_polls').postMessage('updated'); } catch (e) {}
            } catch (e) { console.warn('Could not save polls', e); }
        }

        function render() {
            container.innerHTML = '';
            const polls = loadPolls();
            const surveys = (polls || []).filter(function (p) { return Array.isArray(p.answers) && p.answers.length; });
            if (!surveys.length) {
                const p = document.createElement('p');
                p.textContent = 'Keine Umfragen vorhanden.';
                container.appendChild(p);
                return;
            }

            surveys.forEach(function (poll) {
                const box = document.createElement('div');
                box.className = 'survey';

                const q = document.createElement('div');
                q.className = 'poll-question';
                q.textContent = poll.text || poll.question || 'Frage';
                box.appendChild(q);

                const opts = document.createElement('div');
                opts.className = 'poll-options';

                var votedKey = loadVotes()[poll.id];
                if (Array.isArray(poll.answers) && poll.answers.length) {
                    // multi-choice survey
                    poll.answers.forEach(function (ans, idx) {
                        const btn = document.createElement('button');
                        btn.className = 'poll-option';
                        btn.textContent = (ans.text || ('Option ' + (idx+1))) + ' (' + (ans.count||0) + ')';
                        // disable if already voted
                        if (votedKey !== undefined) {
                            btn.disabled = true;
                            if (String(votedKey) === 'ans:' + idx) btn.classList.add('voted');
                        } else {
                            btn.addEventListener('click', function () { voteAnswer(poll.id, idx); });
                        }
                        opts.appendChild(btn);
                    });
                } else {
                    const yes = poll.yes || 0;
                    const neutral = poll.neutral || 0;
                    const no = poll.no || 0;

                    const yesBtn = document.createElement('button');
                    yesBtn.className = 'poll-option';
                    yesBtn.textContent = `üòä ${yes}`;
                    if (votedKey !== undefined) { yesBtn.disabled = true; if (votedKey === 'yes') yesBtn.classList.add('voted'); } else { yesBtn.addEventListener('click', function () { vote(poll.id, 'yes'); }); }

                    const neutralBtn = document.createElement('button');
                    neutralBtn.className = 'poll-option';
                    neutralBtn.textContent = `üòê ${neutral}`;
                    if (votedKey !== undefined) { neutralBtn.disabled = true; if (votedKey === 'neutral') neutralBtn.classList.add('voted'); } else { neutralBtn.addEventListener('click', function () { vote(poll.id, 'neutral'); }); }

                    const noBtn = document.createElement('button');
                    noBtn.className = 'poll-option';
                    noBtn.textContent = `‚òπÔ∏è ${no}`;
                    if (votedKey !== undefined) { noBtn.disabled = true; if (votedKey === 'no') noBtn.classList.add('voted'); } else { noBtn.addEventListener('click', function () { vote(poll.id, 'no'); }); }

                    opts.appendChild(yesBtn);
                    opts.appendChild(neutralBtn);
                    opts.appendChild(noBtn);
                }

                box.appendChild(opts);


                container.appendChild(box);
            });
        }


        function ensureImportedSurveys() {
            try {
                var polls = loadPolls() || [];
                var rawSaved = localStorage.getItem('savedSurveys');
                if (!rawSaved) return;
                var saved = JSON.parse(rawSaved || '[]');
                if (!Array.isArray(saved) || !saved.length) return;

                var changed = false;
                saved.forEach(function (s) {
                    if (!s || !s.id) return;
                    if (polls.find(function (p) { return p.id === s.id; })) return;
                    var answers = Array.isArray(s.answers) ? s.answers.map(function (a) { return { text: a, count: 0 }; }) : [];
                    if (!answers.length) return;
                    polls.unshift({ id: s.id, text: s.question || s.text || '', answers: answers, createdAt: Date.now() });
                    changed = true;
                });

                if (changed) {
                    savePolls(polls);
                    console.log('HandyHome: merged', saved.length, 'savedSurveys into rating_polls (new total:', polls.length + ')');
                } else {
                    console.log('HandyHome: no new savedSurveys to import (rating_polls length =', polls.length, ')');
                }
            } catch (e) { console.warn('Could not import savedSurveys into rating_polls', e); }
        }

        function vote(id, choice) {
            const polls = loadPolls();
            const p = polls.find(function (x) { return x.id === id; });
            if (!p) return;
            // prevent multiple votes from same device
            if (hasVoted(id)) { alert('Du hast bereits abgestimmt.'); return; }
            if (choice === 'yes') p.yes = (p.yes || 0) + 1;
            else if (choice === 'neutral') p.neutral = (p.neutral || 0) + 1;
            else if (choice === 'no') p.no = (p.no || 0) + 1;
            recordVoteLocal(id, choice);
            savePolls(polls);
            render();
        }

        function voteAnswer(id, answerIndex) {
            const polls = loadPolls();
            const p = polls.find(function (x) { return x.id === id; });
            if (!p || !Array.isArray(p.answers) || !p.answers[answerIndex]) return;
            if (hasVoted(id)) { alert('Du hast bereits abgestimmt.'); return; }
            p.answers[answerIndex].count = (p.answers[answerIndex].count || 0) + 1;
            recordVoteLocal(id, 'ans:' + answerIndex);
            savePolls(polls);
            render();
        }

        window.addEventListener('storage', function (e) {
            if (!e || !e.key) return;
            if (e.key === POLLS_KEY) render();
        });

        try {
            if (window.BroadcastChannel) {
                const bc = new BroadcastChannel('rating_polls');
                bc.addEventListener('message', function () { render(); });
            }
        } catch (e) { }

        ensureImportedSurveys();
        const pollsAfter = loadPolls();
        console.log('HandyHome: polls after import check =', pollsAfter.length);
        render();
    });
    </script>
</body>
</html>