<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Fragen</title>
    <link rel="stylesheet" href="HandyQuestions.css">
    <link rel="stylesheet" href="Handyleiste.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;500;600;700&display=swap" rel="stylesheet">
</head>
<body>
    <div class="bottom-nav">
        <button id="fragen" class="active">Fragen</button>
        <button id="home" onclick="window.location.href='HandyHome.html'">Home</button>
        <button id="raeume" onclick="window.location.href='HandyRäume.html'">Räume</button>
    </div>

    <div class="questions-container">
        <h1>Fragen</h1>

        <div class="questions-list" id="questionsList">

        </div>

        <div class="question-input-area">
            <input type="text" id="questionInput" class="input-question" placeholder="Stelle eine Frage...">
            <button id="submitQuestion" class="input-submit">Frage abschicken</button>
        </div>
    </div>

<script>
    window.USER_TYPE = 'student';
    const VOTE_KEY = 'hci_votes_v1_' + window.USER_TYPE;

    function loadVotes() {
        try {
            return JSON.parse(localStorage.getItem(VOTE_KEY)) || {};
        } catch {
            return {};
        }
    }

    function saveVotes(votes) {
        localStorage.setItem(VOTE_KEY, JSON.stringify(votes));
    }

(function () {
    const STORAGE_KEY = 'hci_questions_v1';
    const listEl = document.getElementById('questionsList');
    const inputEl = document.getElementById('questionInput');
    const submitBtn = document.getElementById('submitQuestion');

    function loadQuestions() {
        try {
            const raw = localStorage.getItem(STORAGE_KEY);
            return raw ? JSON.parse(raw) : [];
        } catch (e) { console.warn('Fehler beim Laden der Fragen', e); return []; }
    }
    function saveQuestions(arr) {
        try {
            localStorage.setItem(STORAGE_KEY, JSON.stringify(arr));
            try { if (window.BroadcastChannel) new BroadcastChannel('hci_questions').postMessage('updated'); } catch (e) {}
        } catch (e) { console.warn('Fehler beim Speichern der Fragen', e); }
    }

    function createCard(q) {
        const card = document.createElement('div');
        card.className = 'question-card';
        card.dataset.id = q.id;

        const meta = document.createElement('p');
        meta.className = 'question-meta';
        meta.textContent = 'Ein Student fragt:';
        card.appendChild(meta);

        const txt = document.createElement('p');
        txt.className = 'question-text';
        txt.textContent = q.text || '';
        card.appendChild(txt);

        const actions = document.createElement('div');
        actions.className = 'question-actions';

        const up = document.createElement('button');
        up.className = 'upvote';
        up.dataset.id = q.id;
        up.innerHTML = '⬆ <span>' + (q.votes || 0) + '</span>';

        const down = document.createElement('button');
        down.className = 'downvote';
        down.dataset.id = q.id;
        down.textContent = '⬇';

        actions.appendChild(up);
        actions.appendChild(down);
        card.appendChild(actions);

        const votesState = loadVotes();           
        const currentVote = votesState[q.id];

        up.classList.remove('active');
        down.classList.remove('active');

        if (currentVote === 'up') up.classList.add('active');
        if (currentVote === 'down') down.classList.add('active');

        return card;
    }

    function render() {
        const qs = loadQuestions();
        listEl.innerHTML = '';
        if (!qs || !qs.length) {
            const empty = document.createElement('p');
            empty.textContent = 'Keine Fragen vorhanden.';
            listEl.appendChild(empty);
            return;
        }
        qs.sort((a,b) => (b.votes||0) - (a.votes||0) || (a.created||0) - (b.created||0));
        qs.forEach(q => listEl.appendChild(createCard(q)));
    }

    function addQuestion(text) {
        if (!text || !text.trim()) return;
        const qs = loadQuestions();
        const item = { id: Date.now().toString(36) + Math.random().toString(36).slice(2,8), text: text.trim(), votes: 0, created: Date.now() };
        qs.push(item);
        saveQuestions(qs);
        render();
    }

    function updateVotes(questionId, delta) {
        const votesState = loadVotes();
        const qs = loadQuestions();
        const idx = qs.findIndex(x => x.id === questionId);
        if (idx === -1) return;

        const currentVote = votesState[questionId];

        if (delta > 0) {
            if (currentVote === 'up') {
                qs[idx].votes -= 1;
                votesState[questionId] = null;
            } else if (currentVote === 'down') {
                qs[idx].votes += 2;
                votesState[questionId] = 'up';
            } else {
                qs[idx].votes += 1;
                votesState[questionId] = 'up';
            }
        } else if (delta < 0) {
            if (currentVote === 'down') {
                qs[idx].votes += 1;
                votesState[questionId] = null;
            } else if (currentVote === 'up') {
                qs[idx].votes -= 2;
                votesState[questionId] = 'down';
            } else {
                qs[idx].votes -= 1;
                votesState[questionId] = 'down';
            }
        }

        saveVotes(votesState);
        saveQuestions(qs);
        render();
    }

    listEl.addEventListener('click', function (e) {
        const up = e.target.closest('.upvote');
        const down = e.target.closest('.downvote');
        if (up) {
            const id = up.dataset.id;
            updateVotes(id, +1);
        } else if (down) {
            const id = down.dataset.id;
            updateVotes(id, -1);
        }
    });

    submitBtn.addEventListener('click', function (ev) {
        ev.preventDefault();
        addQuestion(inputEl.value);
        inputEl.value = '';
    });
    inputEl.addEventListener('keypress', function (e) {
        if (e.key === 'Enter') {
            e.preventDefault();
            submitBtn.click();
        }
    });

    window.addEventListener('storage', function (e) {
        if (!e || !e.key) return;
        if (e.key === STORAGE_KEY) render();
    });
    try {
        if (window.BroadcastChannel) {
            const bc = new BroadcastChannel('hci_questions');
            bc.addEventListener('message', function () { render(); });
        }
    } catch (e) {}


    document.addEventListener('DOMContentLoaded', render);
    if (document.readyState === 'complete' || document.readyState === 'interactive') render();
})();
</script>
</body>
</html>